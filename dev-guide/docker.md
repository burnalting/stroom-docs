# Running Stroom in a Docker Container

This is how to run Stroom in a Docker container (assuming you have already installed Docker). There are two options for running Stroom within a Docker container.

* [Using a pre-built Docker Hub image](#using-a-pre-built-docker-hub-image)
* [Building a Docker image from a Stroom distribution](#building-a-docker-image-from-a-stroom-distribution)

The first option of using a pre-built _Docker Hub_ image is the quickest and easiest way to get Stroom up and running.

## Using a pre-built _Docker Hub_ image

```bash
# If you have already run stroom/stroom-db in Docker then clean up any old images
docker stop stroom
docker stop stroom-db
docker rm stroom
docker rm stroom-db
docker rmi stroom

# Run the MySQL docker image
docker run --name stroom-db -e MYSQL_ROOT_PASSWORD=my-secret-pw -e MYSQL_USER=stroomuser -e MYSQL_PASSWORD=stroompassword1 -e MYSQL_DATABASE=stroom -d mysql:5.5

# Run the Stroom docker image
docker run -p 8080:8080 --link stroom-db -v ~/.stroom.conf.d:/root/.stroom.conf.d --name=stroom -e STROOM_JDBC_DRIVER_URL="jdbc:mysql://stroom-db/stroom?useUnicode=yes&characterEncoding=UTF-8" -e STROOM_JDBC_DRIVER_USERNAME="stroomuser" -e STROOM_JDBC_DRIVER_PASSWORD="stroompassword1" gchq/stroom
```

Now open a browser (preferably Chrome) at [localhost:8080/stroom](http://localhost:8080/stroom) to get started with Stroom.

## Building a Docker image from a Stroom distribution

These instructions show how to build MySQL from Docker Hub and Stroom from source code. 

### MySQL 
```bash
# Clean up if necessary
docker stop stroom-db
docker rm stroom-db

# Run the MySQL docker image
docker run --name stroom-db -e MYSQL_ROOT_PASSWORD=my-secret-pw -e MYSQL_USER=stroomuser -e MYSQL_PASSWORD=stroompassword1 -e MYSQL_DATABASE=stroom -d mysql:5.5
```

#### If you want to...
##### Log on to MySQL as stroomuser
`docker run -it --link stroom-db:mysql --rm mysql sh -c 'exec mysql -h"$MYSQL_PORT_3306_TCP_ADDR" -P"$MYSQL_PORT_3306_TCP_PORT" -u"stroomuser" -p"stroompassword1" stroom'`

##### Log on to MySQL as root
`docker run -it --link stroom-db:mysql --rm mysql sh -c 'exec mysql -h"$MYSQL_PORT_3306_TCP_ADDR" -P"$MYSQL_PORT_3306_TCP_PORT" -u"root" -p"my-secret-pw" stroom'`



### Stroom

#### Create configuration file
Stroom will look for configuration in `~/.stroom.conf.d/stroom.conf`. You can create a basic configuration file like this:

```bash
mkdir ~/.stroom.conf.d
cd ~/.stroom.conf.d
wget https://raw.githubusercontent.com/gchq/stroom-docs/master/dev-guide/resources/stroom.conf
```

#### Clone and build `event-logging`

```bash
git clone https://github.com/gchq/event-logging.git
cd event-logging
mvn clean install
cd ..
```

#### Clone and build `stroom`

```bash
git clone https://github.com/gchq.git
mvn clean install
```

####  Unpack the Stroom distribution in preparation for building the docker image

```bash
cd stroom-app-distribution
unzip target/stroom-app-distribution-<version>-bin.zip -d target
```

g### Building and running the docker image

```bash
docker stop stroom
docker rm stroom
docker rmi stroom

docker build --tag=stroom:latest target/stroom-app
docker run -p 8080:8080 --link stroom-db -v ~/.stroom.conf.d:/root/.stroom.conf.d --name=stroom -e STROOM_JDBC_DRIVER_URL="jdbc:mysql://stroom-db/stroom?useUnicode=yes&characterEncoding=UTF-8" -e STROOM_JDBC_DRIVER_USERNAME="stroomuser" -e STROOM_JDBC_DRIVER_PASSWORD="stroompassword1" stroom
```

Navigate to [http://localhost:8080/stroom/stroom.jsp](http://localhost:8080/stroom/stroom.jsp) to see Stroom running.
